import csv
import json
import os
from datetime import date

# --- Settings ---
INPUT_CSV = "Bukhari/ambiguous_narrators_for_llm.csv"
OUTPUT_JSON = "Bukhari/resolved_context_mappings.json"


# Names that are in the unambiguous dictionary (section 1) - used for type detection
_UNAMBIGUOUS_NAMES = None  # Lazily initialized

# Names that require context (section 2)
_CONTEXT_DEPENDENT_NAMES = frozenset([
    'سفيان', 'حماد', 'إسماعيل', 'يحيى', 'هشام', 'عبد الله',
    'عمرو', 'إبراهيم', 'سعيد', 'سليمان', 'محمد', 'علي', 'إسحاق', 'حفص',
])

# Pronoun names (section 3)
_PRONOUN_NAMES = frozenset(['أبيه', 'أبي', 'أبوه', 'جده', 'أمه', 'أخي', 'أخيه', 'عمه'])


def get_resolution_type(name):
    """Determine which resolution category a name falls into."""
    global _UNAMBIGUOUS_NAMES
    if _UNAMBIGUOUS_NAMES is None:
        # Initialize from the dictionary inside resolve_ambiguous
        # We call it once with a dummy to extract the set
        _UNAMBIGUOUS_NAMES = _build_unambiguous_set()

    if name in _UNAMBIGUOUS_NAMES:
        return 'unambiguous'
    if name in _CONTEXT_DEPENDENT_NAMES:
        return 'context'
    if name in _PRONOUN_NAMES:
        return 'pronoun'
    return 'remaining'


def resolve_ambiguous(name, student):
    """
    Context-aware narrator disambiguation based on hadith scholarship (علم الرجال).

    Uses known teacher-student relationships in Sahih al-Bukhari to resolve
    ambiguous narrator names to their full canonical forms.

    Args:
        name: The ambiguous narrator name (e.g., 'سفيان')
        student: The name of the narrator transmitting FROM them (e.g., 'الحميدي')

    Returns:
        Full canonical name or None if unresolvable
    """

    # ================================================================
    # 1. UNAMBIGUOUS NAMES (only one person in Bukhari with this name)
    # ================================================================

    unambiguous = {
        # Companions (Sahaba) and Mothers of Believers
        'عائشة': 'عائشة بنت أبي بكر',
        'أنس': 'أنس بن مالك',
        'جابر': 'جابر بن عبد الله',
        'البراء': 'البراء بن عازب',
        'خباب': 'خباب بن الأرت',
        'حذيفة': 'حذيفة بن اليمان',
        'أسماء': 'أسماء بنت أبي بكر',
        'ميمونة': 'ميمونة بنت الحارث',
        'حفصة': 'حفصة بنت عمر',
        'سمرة': 'سمرة بن جندب',
        'عمران': 'عمران بن حصين',
        'عبادة': 'عبادة بن الصامت',
        'المسور': 'المسور بن مخرمة',
        'الزبير': 'الزبير بن العوام',
        'النعمان': 'النعمان بن بشير',
        'بريدة': 'بريدة بن الحصيب',
        'سلمة': 'سلمة بن الأكوع',
        'مجاشع': 'مجاشع بن مسعود',
        'جندب': 'جندب بن عبد الله',
        'سهل': 'سهل بن سعد',
        'عمار': 'عمار بن ياسر',
        'كعب': 'كعب بن مالك',
        'عقبة': 'عقبة بن عامر',
        'أسامة': 'أسامة بن زيد',

        # Major Imams and Scholars
        'مالك': 'مالك بن أنس',
        'الزهري': 'محمد بن مسلم الزهري',
        'قتادة': 'قتادة بن دعامة',
        'نافع': 'نافع مولى ابن عمر',
        'الليث': 'الليث بن سعد',
        'الأعمش': 'سليمان بن مهران الأعمش',
        'الثوري': 'سفيان الثوري',
        'الأوزاعي': 'عبد الرحمن بن عمرو الأوزاعي',
        'الشعبي': 'عامر الشعبي',
        'مجاهد': 'مجاهد بن جبر',
        'عكرمة': 'عكرمة مولى ابن عباس',
        'طاوس': 'طاوس بن كيسان',
        'الحسن': 'الحسن البصري',
        'شعبة': 'شعبة بن الحجاج',

        # Well-known narrators (unique in Bukhari)
        'مسدد': 'مسدد بن مسرهد',
        'آدم': 'آدم بن أبي إياس',
        'الحميدي': 'عبد الله بن الزبير الحميدي',
        'عبدان': 'عبدان بن عثمان',
        'وهيب': 'وهيب بن خالد',
        'يونس': 'يونس بن يزيد الأيلي',
        'شعيب': 'شعيب بن أبي حمزة',
        'معمر': 'معمر بن راشد',
        'أيوب': 'أيوب السختياني',
        'عروة': 'عروة بن الزبير',
        'عقيل': 'عقيل بن خالد',
        'عبيد الله': 'عبيد الله بن عمر',
        'منصور': 'منصور بن المعتمر',
        'الأعرج': 'عبد الرحمن بن هرمز',
        'جرير': 'جرير بن عبد الحميد',
        'قتيبة': 'قتيبة بن سعيد',
        'همام': 'همام بن يحيى',
        'عطاء': 'عطاء بن أبي رباح',
        'سالم': 'سالم بن عبد الله بن عمر',
        'غندر': 'محمد بن جعفر غندر',
        'مسروق': 'مسروق بن الأجدع',
        'حميد': 'حميد الطويل',
        'الأسود': 'الأسود بن يزيد',
        'صالح': 'صالح بن كيسان',
        'مسلم': 'مسلم بن إبراهيم',
        'القاسم': 'القاسم بن محمد',
        'قبيصة': 'قبيصة بن عقبة',
        'معتمر': 'معتمر بن سليمان',
        'قيس': 'قيس بن أبي حازم',
        'زهير': 'زهير بن معاوية',
        'علقمة': 'علقمة بن قيس',
        'الحكم': 'الحكم بن عتيبة',
        'شيبان': 'شيبان بن عبد الرحمن',
        'هشيم': 'هشيم بن بشير',
        'وكيع': 'وكيع بن الجراح',
        'كريب': 'كريب مولى ابن عباس',
        'حصين': 'حصين بن عبد الرحمن',
        'شقيق': 'شقيق بن سلمة',
        'الشيباني': 'أبو إسحاق الشيباني',
        'النضر': 'النضر بن شميل',
        'محمود': 'محمود بن غيلان',
        'جويرية': 'جويرية بن أسماء',
        'عوف': 'عوف الأعرابي',
        'فليح': 'فليح بن سليمان',
        'عبدة': 'عبدة بن سليمان',
        'زائدة': 'زائدة بن قدامة',
        'خليفة': 'خليفة بن خياط',
        'حجاج': 'حجاج بن منهال',
        'عبيدة': 'عبيدة السلماني',
        'مسعر': 'مسعر بن كدام',
        'الزبيدي': 'محمد بن الوليد الزبيدي',
        'بريد': 'بريد بن عبد الله',
        'عمرة': 'عمرة بنت عبد الرحمن',
        'الوليد': 'الوليد بن مسلم',
        'روح': 'روح بن عبادة',
        'حبان': 'حبان بن موسى',
        'سمي': 'سمي مولى أبي بكر',
        'عمارة': 'عمارة بن القعقاع',
        'ورقاء': 'ورقاء بن عمر',
        'أصبغ': 'أصبغ بن الفرج',
        'فاطمة': 'فاطمة بنت المنذر',
        'مطرف': 'مطرف بن عبد الله',
        'صدقة': 'صدقة بن الفضل',
        'مغيرة': 'مغيرة بن مقسم',
        'ثمامة': 'ثمامة بن عبد الله بن أنس',
        'عدي': 'عدي بن ثابت',
        'هلال': 'هلال بن علي',
        'مروان': 'مروان بن الحكم',
        'ذكوان': 'أبو صالح السمان',
        'شبابة': 'شبابة بن سوار',
        'فراس': 'فراس بن يحيى',
        'الدراوردي': 'عبد العزيز بن محمد الدراوردي',
        'يعقوب': 'يعقوب بن إبراهيم',
        'بيان': 'بيان بن بشر',
        'أبان': 'أبان بن يزيد',
        'معن': 'معن بن عيسى',
        'الجريري': 'سعيد بن إياس الجريري',
        'المقبري': 'سعيد المقبري',
        'أشعث': 'أشعث بن أبي الشعثاء',
        'خيثمة': 'خيثمة بن عبد الرحمن',
        'أسلم': 'أسلم مولى عمر',
        'الحجاج': 'الحجاج بن منهال',
        'زبيد': 'زبيد اليامي',
        'بشر': 'بشر بن المفضل',
        'حنظلة': 'حنظلة بن أبي سفيان',
        'واصل': 'واصل الأحدب',
        'عنبسة': 'عنبسة بن عبد الواحد',
        'سيار': 'سيار أبو الحكم',
        'حبيب': 'حبيب بن أبي ثابت',
        'الفزاري': 'مروان بن معاوية الفزاري',
        'العوام': 'العوام بن حوشب',
        'زهدم': 'زهدم الجرمي',
        'حيوة': 'حيوة بن شريح',
        'بكر': 'بكر بن عبد الله المزني',
        'ذر': 'ذر بن عبد الله',
        'عفان': 'عفان بن مسلم',
        'الأشعث': 'أشعث بن أبي الشعثاء',
        'ثور': 'ثور بن زيد',
        'عيسى': 'عيسى بن يونس',
        'التيمي': 'سليمان التيمي',
        'مخلد': 'مخلد بن يزيد',
        'سلمان': 'سلمان الفارسي',
        'عياش': 'عياش بن الوليد',
        'مهدي': 'مهدي بن ميمون',
        'داود': 'داود بن أبي هند',
        'مؤمل': 'مؤمل بن هشام',
        'شاذان': 'الأسود بن عامر',
        'بهز': 'بهز بن أسد',
        'حرب': 'حرب بن شداد',
        'قرة': 'قرة بن خالد',
        'محارب': 'محارب بن دثار',
        'ربعي': 'ربعي بن حراش',
        'الماجشون': 'يوسف بن يعقوب الماجشون',
        'مخارق': 'مخارق بن خليفة',
        'طارق': 'طارق بن شهاب',
        'عراك': 'عراك بن مالك',
        'نعيم': 'نعيم بن حماد',
        'واقد': 'واقد بن محمد',
        'محاضر': 'محاضر بن المورع',
        'شريك': 'شريك بن عبد الله',
        'سهيل': 'سهيل بن أبي صالح',
        'معلى': 'معلى بن أسد',
        'فروة': 'فروة بن أبي المغراء',
        'بشير': 'بشير بن كعب',
        'المعتمر': 'معتمر بن سليمان',
        'شبيب': 'شبيب بن سعيد',
        'هند': 'هند بنت الحارث',
        'حمران': 'حمران مولى عثمان',
        'عباد': 'عباد بن تميم',
        'غيلان': 'غيلان بن جرير',
        'قزعة': 'قزعة بن يحيى',
        'الثوري': 'سفيان الثوري',
        'وبرة': 'وبرة بن عبد الرحمن',
        'هدبة': 'هدبة بن خالد',
        'شبل': 'شبل بن حامد',
        'إدريس': 'إدريس بن يحيى',
        'ربيعة': 'ربيعة الرأي',
        'الأويسي': 'عبد العزيز بن عبد الله الأويسي',
        'خلاس': 'خلاس بن عمرو',
        'الصنابحي': 'عبد الرحمن بن عسيلة',
        'أزهر': 'أزهر بن سعد',
        'الربيع': 'الربيع بن خثيم',
        'خلاد': 'خلاد بن يحيى',
        'خبيب': 'خبيب بن عبد الله',
        'أيمن': 'أيمن الحبشي',
        'بكيرا': 'بكير بن عبد الله',
        'عون': 'عون بن أبي جحيفة',
        'سيف': 'سيف بن سليمان',
        'جبلة': 'جبلة بن سحيم',
        'صلة': 'صلة بن زفر',
        'مرة': 'مرة الهمداني',
        'زرارة': 'زرارة بن أوفى',
        'هزيل': 'هزيل بن شرحبيل',
        'ثابت': 'ثابت البناني',
        'ليث': 'الليث بن سعد',
        'خالد': 'خالد الحذاء',
        'عامر': 'عامر الشعبي',
        'زكرياء': 'زكرياء بن أبي زائدة',
        'معاذ': 'معاذ بن فضالة',
        'يزيد': 'يزيد بن زريع',
        'موسى': 'موسى بن إسماعيل',
        'عمر': 'عمر بن الخطاب',
        'عاصم': 'عاصم الأحول',
        'الإسرائيلي': 'إسرائيل بن يونس',
        'إسرائيل': 'إسرائيل بن يونس',
        'المغيرة': 'المغيرة بن شعبة',
        'معاوية': 'معاوية بن أبي سفيان',
        'بكير': 'بكير بن عبد الله',
        'حاتم': 'حاتم بن إسماعيل',
        'الحسين': 'الحسين بن علي',
        'جابرا': 'جابر بن عبد الله',
        'يعلى': 'يعلى بن مسلم',
        'حسين': 'حسين بن علي',
        'طلحة': 'طلحة بن مصرف',
        'يوسف': 'يوسف بن ماهك',
        'الأنصاري': 'محمد بن عبد الله الأنصاري',
        'عفان': 'عفان بن مسلم',
        'هدبة': 'هدبة بن خالد',
        'سعد': 'سعد بن إبراهيم',
        'وهب': 'وهب بن جرير',
        'أحمد': 'أحمد بن يونس',
        'عثمان': 'عثمان بن أبي شيبة',
        'شيبة': 'شيبة بن عثمان',
        'عليا': 'علي بن أبي طالب',
        'الحي': 'شبيب بن غرقدة',
        'الرباب': 'حفصة بنت سيرين',
    }

    if name in unambiguous:
        return unambiguous[name]

    # ================================================================
    # 2. CONTEXT-DEPENDENT NAMES (need student to disambiguate)
    # ================================================================

    # --- سفيان (الثوري vs ابن عيينة) ---
    if name == 'سفيان':
        if any(s in student for s in ['علي بن عبد الله', 'الحميدي', 'قتيبة',
                                       'عبد الله بن يوسف', 'مسدد', 'إسحاق', 'أبو نعيم']):
            return 'سفيان بن عيينة'
        if any(s in student for s in ['يحيى', 'وكيع', 'عبد الرحمن',
                                       'محمد بن يوسف', 'قبيصة', 'عبد الله بن محمد',
                                       'محمد بن كثير']):
            return 'سفيان الثوري'
        if 'البخاري' in student:
            return 'سفيان الثوري'
        return 'سفيان (غامض)'

    # --- حماد (بن زيد vs بن سلمة) ---
    if name == 'حماد':
        if any(s in student for s in ['سليمان بن حرب', 'مسدد', 'أبو النعمان',
                                       'قتيبة', 'حميد']):
            return 'حماد بن زيد'
        if any(s in student for s in ['موسى', 'حجاج', 'أبو الوليد']):
            return 'حماد بن سلمة'
        return 'حماد (غامض)'

    # --- إسماعيل ---
    if name == 'إسماعيل':
        if 'البخاري' in student:
            return 'إسماعيل بن أبي أويس'
        if 'يحيى' in student:
            return 'إسماعيل بن أبي خالد'
        if 'مالك' in student:
            return 'إسماعيل بن أبي حكيم'
        if 'مسدد' in student:
            return 'إسماعيل بن علية'
        return 'إسماعيل (غامض)'

    # --- يحيى (القطان vs الأنصاري vs بكير) ---
    if name == 'يحيى':
        if 'مسدد' in student:
            return 'يحيى بن سعيد القطان'
        if 'البخاري' in student:
            return 'يحيى بن بكير'
        if 'محمد بن المثنى' in student:
            return 'يحيى بن سعيد القطان'
        if 'هشام' in student:
            return 'يحيى بن سعيد الأنصاري'
        return 'يحيى (غامض)'

    # --- هشام (ابن عروة vs الدستوائي vs ابن حسان) ---
    if name == 'هشام':
        if any(s in student for s in ['أبو أسامة', 'إبراهيم بن موسى', 'عبدة']):
            return 'هشام بن عروة'
        if any(s in student for s in ['شعبة', 'همام']):
            return 'هشام الدستوائي'
        if 'مسلم بن إبراهيم' in student:
            return 'هشام الدستوائي'
        # Note: يحيى القطان narrated from ALL THREE Hishams (بن عروة, بن حسان, الدستوائي).
        # Cannot disambiguate with student context alone - need teacher context (next in chain).
        # Previously this was: if 'يحيى' in student: return 'هشام بن حسان' (UNSAFE)
        if 'يحيى' in student:
            return 'هشام (غامض)'
        return 'هشام (غامض)'

    # --- عبد الله (ابن مسعود vs ابن عمر vs ابن المبارك vs ابن عمرو vs ابن عباس) ---
    if name == 'عبد الله':
        # عبد الله بن المبارك (د. 181 هـ) - تلاميذه (شيوخ البخاري)
        if any(s in student for s in ['عبدان', 'محمد بن مقاتل', 'بشر بن محمد',
                                       'يونس', 'الليث', 'محمد بن يوسف', 'ابن مقاتل',
                                       'حبان بن موسى', 'أحمد بن محمد', 'معاذ بن أسد',
                                       'محمد بن سلام']):
            return 'عبد الله بن المبارك'
        # عبد الله بن مسعود (صحابي) - تلاميذه من التابعين
        if any(s in student for s in ['أبو وائل', 'علقمة', 'الأسود', 'شقيق',
                                       'مسروق', 'إبراهيم', 'عبيدة', 'زر بن حبيش',
                                       'عبد الرحمن بن يزيد', 'عمرو بن ميمون',
                                       'زيد بن وهب', 'أبو ميسرة', 'الحارث بن سويد',
                                       'عمرو بن شرحبيل', 'أبو عمرو الشيباني']):
            return 'عبد الله بن مسعود'
        # عبد الله بن عمر (صحابي) - تلاميذه
        if any(s in student for s in ['نافع', 'سالم', 'حمزة', 'الزهري', 'ابن شهاب',
                                       'أبو معمر', 'قيس بن أبي حازم']):
            return 'عبد الله بن عمر'
        # عبد الله بن عباس (صحابي) - تلاميذه
        if any(s in student for s in ['عكرمة', 'عطاء', 'سعيد بن جبير', 'مجاهد',
                                       'طاوس', 'عمرو بن دينار', 'ابن أبي مليكة']):
            return 'عبد الله بن عباس'
        # عبد الله بن الزبير (صحابي)
        if 'عروة' in student or 'عامر بن عبد الله' in student:
            return 'عبد الله بن الزبير'
        # عبد الله بن عمرو بن العاص (صحابي)
        if 'عمرو بن شعيب' in student:
            return 'عبد الله بن عمرو بن العاص'
        # عبد الله بن ذكوان (أبو الزناد)
        if 'أبو الزناد' in student:
            return 'عبد الله بن ذكوان أبو الزناد'
        # Note: البخاري (born 194 AH) could NOT have narrated from ابن المبارك (died 181 AH).
        # When البخاري narrates from عبد الله directly, it's most likely عبد الله بن يوسف التنيسي
        # (his most frequent teacher with 300+ narrations) or عبد الله بن محمد المسندي.
        # Since both are possible, mark as ambiguous rather than guess wrong.
        if 'البخاري' in student:
            return 'عبد الله (غامض)'
        return 'عبد الله (غامض)'

    # --- عمرو (بن دينار vs بن مرة) ---
    if name == 'عمرو':
        if any(s in student for s in ['سفيان', 'عطاء', 'ابن جريج']):
            return 'عمرو بن دينار'
        if 'شعبة' in student:
            return 'عمرو بن مرة'
        if 'ابن وهب' in student:
            return 'عمرو بن الحارث'
        return 'عمرو (غامض)'

    # --- إبراهيم (النخعي vs ابن سعد vs ابن المنذر) ---
    if name == 'إبراهيم':
        if any(s in student for s in ['الأعمش', 'منصور', 'علقمة']):
            return 'إبراهيم النخعي'
        if 'يعقوب بن إبراهيم' in student:
            return 'إبراهيم بن سعد'
        if 'البخاري' in student:
            return 'إبراهيم بن المنذر'
        return 'إبراهيم (غامض)'

    # --- سعيد (ابن المسيب vs ابن أبي عروبة) ---
    if name == 'سعيد':
        if 'يزيد بن زريع' in student:
            return 'سعيد بن أبي عروبة'
        if 'قتادة' in student:
            return 'سعيد بن أبي عروبة'
        return 'سعيد (غامض)'

    # --- سليمان ---
    if name == 'سليمان':
        if 'شعبة' in student:
            return 'سليمان الأعمش'
        return 'سليمان بن حرب'

    # --- محمد ---
    if name == 'محمد':
        if 'البخاري' in student:
            return 'محمد بن سلام'
        if 'أيوب' in student:
            return 'محمد بن سيرين'
        return 'محمد (غامض)'

    # --- علي ---
    if name == 'علي':
        if 'البخاري' in student:
            return 'علي بن عبد الله المديني'
        return 'علي (غامض)'

    # --- إسحاق ---
    if name == 'إسحاق':
        if 'البخاري' in student:
            return 'إسحاق بن راهويه'
        return 'إسحاق (غامض)'

    # --- حفص ---
    if name == 'حفص':
        if 'عمر بن حفص' in student:
            return 'حفص بن غياث'
        return 'حفص بن عمر'

    # ================================================================
    # 3. PRONOUNS (أبيه, أبي, جده, أمه, أخي, أخيه, أبوه)
    # Resolved by identifying the student's father
    # ================================================================

    if name in ('أبيه', 'أبي', 'أبوه'):
        # Known father-son pairs in Bukhari (student -> father)
        father_lookup = {
            'هشام': 'عروة بن الزبير',
            'هشام بن عروة': 'عروة بن الزبير',
            'سالم': 'عبد الله بن عمر',
            'سالم بن عبد الله': 'عبد الله بن عمر',
            'حمزة': 'عبد الله بن عمر',
            'حمزة بن عبد الله': 'عبد الله بن عمر',
            'عبيد الله': 'عبد الله بن عمر',
            'عبيد الله بن عبد الله': 'عبد الله بن عمر',
            'ابن طاوس': 'طاوس بن كيسان',
            'عبد الله بن طاوس': 'طاوس بن كيسان',
            'معتمر': 'سليمان التيمي',
            'معتمر بن سليمان': 'سليمان التيمي',
            'سعيد المقبري': 'أبو سعيد المقبري',
            'سعيد بن أبي سعيد': 'أبو سعيد المقبري',
            'سعيد بن أبي سعيد المقبري': 'أبو سعيد المقبري',
            'عبد الله بن أبي قتادة': 'أبو قتادة الأنصاري',
            'إبراهيم بن سعد': 'سعد بن إبراهيم',
            'عمرو بن يحيى': 'يحيى بن عمارة',
            'عمرو بن يحيى المازني': 'يحيى بن عمارة',
            'عمر بن حفص': 'حفص بن غياث',
            'عمر بن حفص بن غياث': 'حفص بن غياث',
            'سعيد بن عبد الرحمن بن أبزى': 'عبد الرحمن بن أبزى',
            'إبراهيم التيمي': 'يزيد بن شريك التيمي',
            'إبراهيم بن يزيد التيمي': 'يزيد بن شريك التيمي',
            'عبد الرحمن بن القاسم': 'القاسم بن محمد',
            'زيد بن أسلم': 'أسلم مولى عمر',
            'عبد الرحمن بن أبي بكرة': 'أبو بكرة نفيع بن الحارث',
            'أبو بردة': 'أبو موسى الأشعري',
            'أبو بردة بن أبي موسى': 'أبو موسى الأشعري',
            'سعيد بن أبي بردة': 'أبو بردة بن أبي موسى',
            'ابن أبي حازم': 'أبو حازم سلمة بن دينار',
            'عبد العزيز بن أبي حازم': 'أبو حازم سلمة بن دينار',
            'سعيد بن المسيب': 'المسيب بن حزن',
            'عبدان': 'عثمان بن جبلة',
            'عبد الصمد': 'عبد الوارث بن سعيد',
            'عبد الصمد بن عبد الوارث': 'عبد الوارث بن سعيد',
            'عبد الرحمن بن عبد الله بن دينار': 'عبد الله بن دينار',
            'عون بن أبي جحيفة': 'أبو جحيفة وهب بن عبد الله',
            'عبد الرحمن بن عابس': 'عابس بن ربيعة',
            'عبد الرحمن بن عبد الله بن عبد الرحمن بن أبي صعصعة': 'عبد الله بن عبد الرحمن بن أبي صعصعة',
            'عامر بن عبد الله بن الزبير': 'عبد الله بن الزبير',
            'نافع بن مالك بن أبي عامر أبو سهيل': 'مالك بن أبي عامر',
            'أبو سهيل بن مالك': 'مالك بن أبي عامر',
            'أبو سهيل': 'مالك بن أبي عامر',
            'واقد بن محمد': 'محمد بن زيد بن عبد الله بن عمر',
            'محمد بن عبد الله الأنصاري': 'عبد الله بن المثنى',
            'أشعث بن سليم': 'سليم الأشجعي',
            'عباد بن تميم': 'عبد الله بن زيد',
            # Additional high-frequency father-son pairs (from unresolved analysis)
            'ابن المسيب': 'المسيب بن حزن',
            'إبراهيم النخعي': 'يزيد بن الأسود النخعي',
            'أشعث بن أبي الشعثاء': 'أبو الشعثاء جابر بن زيد',
            'عامر بن سعد': 'سعد بن أبي وقاص',
            'عاصم بن محمد': 'محمد بن زيد بن عبد الله بن عمر',
            'محمد بن جبير بن مطعم': 'جبير بن مطعم',
            'محمد بن فليح': 'فليح بن سليمان',
            'عروة بن المغيرة': 'المغيرة بن شعبة',
            'صفوان بن يعلى': 'يعلى بن أمية',
            'عبد الرحمن بن الأسود': 'الأسود بن يزيد النخعي',
            'ابن أبي زائدة': 'أبو زائدة وهب بن خالد',
            'محمد بن فضيل': 'فضيل بن غزوان',
            'ابن فضيل': 'فضيل بن غزوان',
            'عبد الله بن أبي بكر بن محمد بن عمرو بن حزم': 'أبو بكر بن محمد بن عمرو بن حزم',
            'إبراهيم بن يوسف': 'يوسف بن إسحاق',
            'عبد الواحد بن أيمن': 'أيمن المكي',
            'سفيان الثوري': 'سعيد بن مسروق الثوري',  # أب سفيان الثوري
            'موسى بن عقبة': 'عقبة بن أبي سفيان',
            'القاسم': 'محمد بن أبي بكر',  # القاسم بن محمد
            'أبو الزناد': 'عبد الله بن ذكوان',
            'محمد بن إسحاق': 'إسحاق بن يسار',
            # Additional missing father-son pairs (from unresolved analysis)
            'سعيد بن المسيب': 'المسيب بن حزن',  # 11 cases
            'سفيان الثوري': 'سعيد بن مسروق الثوري',  # 7 cases (already exists but adding full name)
            'أشعث بن أبي الشعثاء': 'أبو الشعثاء جابر بن زيد',  # 6 cases (already exists)
            'إبراهيم النخعي': 'يزيد بن الأسود النخعي',  # 4 cases (already exists)
            'واقد بن محمد': 'محمد بن زيد بن عبد الله بن عمر',  # 3 cases (already exists)
            'سعد بن إبراهيم': 'إبراهيم بن سعد',  # 2 cases (reversed - سعد son of إبراهيم)
            'عبد الله بن أبي بكر': 'أبو بكر بن محمد بن عمرو بن حزم',  # 2 cases
            'أحمد بن شبيب بن سعيد': 'شبيب بن سعيد الحبطي',  # 2 cases
            'أحمد بن شبيب': 'شبيب بن سعيد الحبطي',  # Variant
            'ابن أبي أنس مولى التيميين': 'أبو أنس مالك بن أبي عامر',  # 2 cases
            'إسحاق بن سعيد': 'سعيد بن عمرو بن سعيد',  # 2 cases
            'إسحاق بن سعيد بن عمرو بن سعيد بن العاص': 'سعيد بن عمرو بن سعيد',  # Full name variant
            'عبد الرحمن بن أبي صعصعة': 'أبو صعصعة',  # 2 cases
            'صالح بن إبراهيم': 'إبراهيم بن عبد الرحمن',  # 2 cases
            'أبو بكر بن عبد الله بن قيس': 'عبد الله بن قيس أبو موسى الأشعري',  # 2 cases
            'أبو بكر بن عبد الله': 'عبد الله بن قيس أبو موسى الأشعري',  # Variant
            'عمر بن محمد': 'محمد بن زيد بن عبد الله بن عمر',  # 2 cases
            'سهيل بن أبي صالح': 'أبي صالح ذكوان السمان',  # 2 cases
            'عبد الله بن سعيد بن أبي هند': 'سعيد بن أبي هند',  # 2 cases
            'عمرو بن دينار': 'دينار مولى ابن عمر',  # 1 case
            'ابن عبد الرحمن بن أبزى': 'عبد الرحمن بن أبزى',  # 1 case (already exists with سعيد prefix)
            'الأشعث بن سليم': 'سليم الأشجعي',  # 1 case (already exists)
            'بشير بن أبي مسعود': 'أبو مسعود عقبة بن عمرو',  # 1 case
            'أبو بكر بن أبي موسى': 'أبو موسى الأشعري',  # 1 case
            'عبد الرحمن بن عبد الله بن عبد الرحمن بن أبي صعصعة الأنصاري ثم المازني': 'عبد الله بن عبد الرحمن بن أبي صعصعة',  # 1 case (long variant)
            'علي بن يحيى بن خلاد الزرقي': 'يحيى بن خلاد الزرقي',  # 1 case
            'عبد الله بن أبي قتادة الأنصاري': 'أبو قتادة الأنصاري',  # 1 case (already exists without الأنصاري)
            'عبد الله بن عامر بن ربيعة': 'عامر بن ربيعة',  # 1 case
            'يعقوب بن إبراهيم بن سعد': 'إبراهيم بن سعد',  # 1 case (already covered by partial match)
            'المسيب بن حزن': 'حزن بن أبي وهب',  # 1 case (المسيب's father)
            'خثيم بن عراك': 'عراك بن مالك',  # 1 case
            'خثيم بن عراك بن مالك': 'عراك بن مالك',  # Full name variant
            'عباس': 'عبد المطلب',  # 1 case (العباس بن عبد المطلب)
            'محمد بن عبد الله بن عبد الرحمن بن أبي صعصعة': 'عبد الله بن عبد الرحمن بن أبي صعصعة',  # 1 case
            'محمد بن عبد الرحمن بن أبي صعصعة المازني': 'عبد الرحمن بن أبي صعصعة',  # 1 case
            'عبيد الله بن عبد الله بن عمر': 'عبد الله بن عمر',  # 1 case
            'محمد بن عبد الله بن نمير': 'عبد الله بن نمير',  # 1 case
            'محمد بن موسى بن أعين': 'موسى بن أعين',  # 1 case
            'عبد الله بن سعيد بن جبير': 'سعيد بن جبير',  # 1 case
            'محمد بن مسلم الزهري': 'مسلم بن عبيد الله الزهري',  # 1 case (الزهري's father)
            'عبد الله بن عثمان بن جبلة': 'عثمان بن جبلة',  # 1 case (عبدان)
            'عبد الواحد بن أيمن المكي': 'أيمن المكي',  # 1 case (already exists)
        }
        if student in father_lookup:
            return father_lookup[student]

        # Short name variations (CSV contains both short and full names)
        # سعيد → can be سعيد المقبري, سعيد بن المسيب, سعيد بن أبي بردة, etc.
        if student == 'سعيد':
            # Default to المسيب بن حزن (سعيد بن المسيب is most common in Bukhari)
            return 'المسيب بن حزن'
        if student == 'سفيان':
            # Default to سعيد بن مسروق (سفيان الثوري)
            return 'سعيد بن مسروق الثوري'
        if student == 'عمرو':
            # Default to دينار (عمرو بن دينار is most common)
            return 'دينار مولى ابن عمر'
        if student == 'واقد':
            return 'محمد بن زيد بن عبد الله بن عمر'
        if student == 'إبراهيم':
            # Default to يزيد بن الأسود (إبراهيم النخعي)
            return 'يزيد بن الأسود النخعي'
        if student == 'أشعث' or student == 'الأشعث':
            return 'أبو الشعثاء جابر بن زيد'
        if student == 'سعد':
            return 'إبراهيم بن سعد'  # سعد بن إبراهيم → أبيه = إبراهيم
        if student == 'المقبري':
            return 'أبو سعيد المقبري'
        if student == 'سهيل':
            return 'أبي صالح ذكوان السمان'
        if student == 'عبد العزيز' or student == 'عبد الرحمن':
            # Too generic - return None for now
            return None
        if student == 'عون':
            return 'أبو جحيفة وهب بن عبد الله'

        # Partial matching for students not in exact lookup (handles full names)
        if 'هشام' in student and ('عروة' in student or student == 'هشام'):
            return 'عروة بن الزبير'
        if 'سالم' in student and 'عبد الله' in student:
            return 'عبد الله بن عمر'
        if 'سعيد' in student and ('المسيب' in student or 'ابن المسيب' in student):
            return 'المسيب بن حزن'
        if 'عامر' in student and 'سعد' in student:
            return 'سعد بن أبي وقاص'
        if 'واقد' in student and 'محمد' in student:
            return 'محمد بن زيد بن عبد الله بن عمر'
        if 'عاصم' in student and 'محمد' in student and ('زيد' in student or 'عبد الله' in student):
            return 'محمد بن زيد بن عبد الله بن عمر'
        if 'إبراهيم' in student and ('النخعي' in student or 'يزيد' in student):
            return 'يزيد بن الأسود النخعي'
        if 'أشعث' in student and ('أبي الشعثاء' in student or 'الشعثاء' in student):
            return 'أبو الشعثاء جابر بن زيد'
        if 'محمد' in student and 'جبير' in student and 'مطعم' in student:
            return 'جبير بن مطعم'
        if 'سعد' in student and 'إبراهيم' in student:
            return 'إبراهيم بن سعد'  # سعد بن إبراهيم → his father is إبراهيم بن سعد
        if 'أبي الزناد' in student or ('أبي' in student and 'الزناد' in student):
            return 'عبد الله بن ذكوان'
        if 'نافع' in student and 'مالك' in student and ('أبي عامر' in student or 'سهيل' in student):
            return 'مالك بن أبي عامر'
        if 'سفيان' in student and 'الثوري' in student:
            return 'سعيد بن مسروق الثوري'
        if 'عمرو' in student and 'دينار' in student:
            return 'دينار مولى ابن عمر'
        # Additional patterns for long names
        if 'أحمد' in student and 'شبيب' in student:
            return 'شبيب بن سعيد الحبطي'
        if 'صالح' in student and 'إبراهيم' in student:
            return 'إبراهيم بن عبد الرحمن'
        if 'أبو بكر' in student and ('عبد الله' in student or 'موسى' in student or 'قيس' in student):
            if 'موسى' in student:
                return 'أبو موسى الأشعري'
            else:
                return 'أبو بكر بن محمد بن عمرو بن حزم'
        if 'سهيل' in student and 'أبي صالح' in student:
            return 'أبي صالح ذكوان السمان'
        if 'بشير' in student and 'مسعود' in student:
            return 'أبو مسعود عقبة بن عمرو'
        if 'خثيم' in student and 'عراك' in student:
            return 'عراك بن مالك'
        if 'يعقوب' in student and 'إبراهيم' in student and 'سعد' in student:
            return 'إبراهيم بن سعد'
        if 'علي' in student and 'يحيى' in student and 'خلاد' in student:
            return 'يحيى بن خلاد الزرقي'
        if 'المسيب' in student and 'حزن' in student:
            return 'حزن بن أبي وهب'
        if student == 'عباس' or ('عباس' in student and 'عبد المطلب' not in student):
            return 'عبد المطلب'
        if 'موسى' in student and 'أعين' in student:
            return 'موسى بن أعين'
        if 'عبد الواحد' in student and 'أيمن' in student:
            return 'أيمن المكي'
        if 'ابن' in student and 'أنس' in student and 'التيمي' in student:
            return 'أبو أنس مالك بن أبي عامر'
        # Additional missing patterns
        if student == 'ابن عمر' or ('ابن' in student and 'عمر' in student and 'الله' not in student):
            return 'عمر بن الخطاب'
        if student == 'ابن نمير' or ('ابن' in student and 'نمير' in student):
            return 'عبد الله بن نمير'
        if student == 'ابن أسلم' or ('زيد' in student and 'أسلم' in student):
            return 'أسلم مولى عمر'
        if student == 'ابن شهاب' or ('محمد' in student and 'مسلم' in student and 'الزهري' in student):
            return 'مسلم بن عبيد الله الزهري'
        if 'يعقوب' in student and 'إبراهيم' in student:
            return 'إبراهيم بن سعد'
        if 'حمزة' in student and 'أسيد' in student:
            return 'أبو أسيد مالك بن ربيعة'
        if 'يحيى' in student and 'زائدة' in student:
            return 'أبو زائدة وهب بن خالد'
        if 'خالد' in student and 'سعيد' in student:
            return 'سعيد بن أبي سعيد'
        if 'معن' in student and 'عبد الرحمن' in student:
            return 'عبد الرحمن بن أبي الزناد'
        if 'يوسف' in student and 'إسحاق' in student:
            return 'إسحاق بن يسار'

        return None

    if name == 'جده':
        if 'أبيه' in student:
            return None  # Needs more context
        return None

    if name == 'أمه':
        if 'منصور بن صفية' in student:
            return 'صفية بنت شيبة'
        return None

    if name in ('أخي', 'أخيه'):
        if 'إسماعيل' in student:
            return None  # Ambiguous without more context
        return None

    if name == 'عمه':
        if 'عباد بن تميم' in student:
            return 'عبد الله بن زيد'
        return None

    # ================================================================
    # 4. REMAINING IDENTIFIABLE NAMES (less common but resolvable)
    # ================================================================

    remaining = {
        'صفية': 'صفية بنت حيي',
        'زينب': 'زينب بنت أبي سلمة',
        'غيره': None,  # "someone else" - unresolvable
        'رجل': None,  # "a man" - unresolvable
        'عبة': None,  # likely a truncation/error
        'زياد': 'زياد بن سعد',
        'زيد': 'زيد بن أسلم',
        'حمزة': 'حمزة بن عبد الله بن عمر',
        'جعفر': 'جعفر بن ربيعة',
        'وراد': 'وراد كاتب المغيرة',
    }

    if name in remaining:
        return remaining[name]

    return None


def _build_unambiguous_set():
    """Extract the set of unambiguous names from resolve_ambiguous's dictionary.
    Called once to initialize _UNAMBIGUOUS_NAMES."""
    # These are the names that map 1:1 (only one person with this name in Bukhari)
    # Mirrors the 'unambiguous' dict inside resolve_ambiguous()
    return frozenset([
        'عائشة', 'أنس', 'جابر', 'البراء', 'خباب', 'حذيفة', 'أسماء', 'ميمونة',
        'حفصة', 'سمرة', 'عمران', 'عبادة', 'المسور', 'الزبير', 'النعمان', 'بريدة',
        'سلمة', 'مجاشع', 'جندب', 'سهل', 'عمار', 'كعب', 'عقبة', 'أسامة',
        'مالك', 'الزهري', 'قتادة', 'نافع', 'الليث', 'الأعمش', 'الثوري',
        'الأوزاعي', 'الشعبي', 'مجاهد', 'عكرمة', 'طاوس', 'الحسن', 'شعبة',
        'مسدد', 'آدم', 'الحميدي', 'عبدان', 'وهيب', 'يونس', 'شعيب', 'معمر',
        'أيوب', 'عروة', 'عقيل', 'عبيد الله', 'منصور', 'الأعرج', 'جرير',
        'قتيبة', 'همام', 'عطاء', 'سالم', 'غندر', 'مسروق', 'حميد', 'الأسود',
        'صالح', 'مسلم', 'القاسم', 'قبيصة', 'معتمر', 'قيس', 'زهير', 'علقمة',
        'الحكم', 'شيبان', 'هشيم', 'وكيع', 'كريب', 'حصين', 'شقيق', 'الشيباني',
        'النضر', 'محمود', 'جويرية', 'عوف', 'فليح', 'عبدة', 'زائدة', 'خليفة',
        'حجاج', 'عبيدة', 'مسعر', 'الزبيدي', 'بريد', 'عمرة', 'الوليد', 'روح',
        'حبان', 'سمي', 'عمارة', 'ورقاء', 'أصبغ', 'فاطمة', 'مطرف', 'صدقة',
        'مغيرة', 'ثمامة', 'عدي', 'هلال', 'مروان', 'ذكوان', 'شبابة', 'فراس',
        'الدراوردي', 'يعقوب', 'بيان', 'أبان', 'معن', 'الجريري', 'المقبري',
        'أشعث', 'خيثمة', 'أسلم', 'الحجاج', 'زبيد', 'بشر', 'حنظلة', 'واصل',
        'عنبسة', 'سيار', 'حبيب', 'الفزاري', 'العوام', 'زهدم', 'حيوة', 'بكر',
        'ذر', 'عفان', 'الأشعث', 'ثور', 'عيسى', 'التيمي', 'مخلد', 'سلمان',
        'عياش', 'مهدي', 'داود', 'مؤمل', 'شاذان', 'بهز', 'حرب', 'قرة',
        'محارب', 'ربعي', 'الماجشون', 'مخارق', 'طارق', 'عراك', 'نعيم', 'واقد',
        'محاضر', 'شريك', 'سهيل', 'معلى', 'فروة', 'بشير', 'المعتمر', 'شبيب',
        'هند', 'حمران', 'عباد', 'غيلان', 'قزعة', 'الثوري', 'وبرة', 'هدبة',
        'شبل', 'إدريس', 'ربيعة', 'الأويسي', 'خلاس', 'الصنابحي', 'أزهر',
        'الربيع', 'خلاد', 'خبيب', 'أيمن', 'بكيرا', 'عون', 'سيف', 'جبلة',
        'صلة', 'مرة', 'زرارة', 'هزيل', 'ثابت', 'ليث', 'خالد', 'عامر',
        'زكرياء', 'معاذ', 'يزيد', 'موسى', 'عمر', 'عاصم', 'الإسرائيلي',
        'إسرائيل', 'المغيرة', 'معاوية', 'بكير', 'حاتم', 'الحسين', 'جابرا',
        'يعلى', 'حسين', 'طلحة', 'يوسف', 'الأنصاري', 'عفان', 'هدبة', 'سعد',
        'وهب', 'أحمد', 'عثمان', 'شيبة', 'عليا', 'الحي', 'الرباب',
    ])


def generate_context_mappings():
    """Read the CSV and generate context-aware mappings."""

    if not os.path.exists(INPUT_CSV):
        print(f"File not found: {INPUT_CSV}")
        return

    print(f"Reading {INPUT_CSV}...")

    context_mappings = {}
    unresolved = []
    stats = {'total': 0, 'resolved': 0, 'unresolved': 0}

    with open(INPUT_CSV, 'r', encoding='utf-8') as f:
        reader = csv.DictReader(f)
        for row in reader:
            ambiguous_name = row['Ambiguous Name'].strip()
            student_name = row['Student (Narrator From)'].strip()
            frequency = int(row['Frequency'])
            stats['total'] += 1

            result = resolve_ambiguous(ambiguous_name, student_name)

            if result:
                key = f"{ambiguous_name}|{student_name}"
                context_mappings[key] = result
                stats['resolved'] += 1
            else:
                unresolved.append({
                    'name': ambiguous_name,
                    'student': student_name,
                    'frequency': frequency
                })
                stats['unresolved'] += 1

    # Build output
    output = {
        "metadata": {
            "description": "Context-aware narrator disambiguation mappings for Sahih al-Bukhari",
            "generated_by": "solve_ambiguity.py",
            "generated_at": str(date.today()),
            "total_rows": stats['total'],
            "resolved": stats['resolved'],
            "unresolved": stats['unresolved'],
            "coverage": f"{(stats['resolved'] / stats['total'] * 100):.1f}%"
        },
        "context_mappings": context_mappings,
        "unresolved": unresolved
    }

    print(f"Saving to {OUTPUT_JSON}...")
    with open(OUTPUT_JSON, 'w', encoding='utf-8') as f:
        json.dump(output, f, ensure_ascii=False, indent=2)

    print(f"\nResults:")
    print(f"  Total rows:  {stats['total']}")
    print(f"  Resolved:    {stats['resolved']}")
    print(f"  Unresolved:  {stats['unresolved']}")
    print(f"  Coverage:    {(stats['resolved'] / stats['total'] * 100):.1f}%")

    if unresolved:
        print(f"\nTop unresolved (by frequency):")
        for entry in sorted(unresolved, key=lambda x: x['frequency'], reverse=True)[:15]:
            print(f"  {entry['name']} | {entry['student']} ({entry['frequency']})")


if __name__ == "__main__":
    generate_context_mappings()
